define(["jquery","windows/windows","websockets/binary_websockets","lodash","common/rivetsExtra","moment","jquery-growl","common/util"],function(a,b,c,d,e,f){function g(){l.exclude_until&&f.utc(l.exclude_until,"YYYY-MM-DD").isAfter(f.utc().startOf("day"))&&d.defer(function(){a.growl.error({message:"You have excluded yourself until ".i18n()+l.exclude_until}),c.invalidate()})}var h=null,i=null,j=null,k={max_balance:{limit:1e19,set:!1,name:"Maximum balance"},max_turnover:{limit:1e20,set:!1,name:"Daily turnover limit"},max_losses:{limit:1e20,set:!1,name:"Daily limit on losses"},max_7day_turnover:{limit:1e20,set:!1,name:"7-day turnover limit"},max_7day_losses:{limit:1e20,set:!1,name:"7-day limit on losses"},max_30day_turnover:{limit:1e20,set:!1,name:"30-day turnover limit"},max_30day_losses:{limit:1e20,set:!1,name:"30-day limit on losses"},max_open_bets:{limit:101,set:!1,name:"Maximum open positions"},session_duration_limit:{limit:60480,set:!1,name:"Session duration limit"},exclude_until:{limit:null,set:!1,name:"Exclude time"}},l={max_balance:null,max_turnover:null,max_losses:null,max_7day_turnover:null,max_7day_losses:null,max_30day_turnover:null,max_30day_losses:null,max_open_bets:null,session_duration_limit:null,exclude_until:null,update:function(b,d){var e={set_self_exclusion:1},h=!0;a.each(k,function(b,c){if(d[b]||c.set){if("exclude_until"===b&&f.utc(d.exclude_until,"YYYY-MM-DD").isBefore(f.utc().startOf("day").add(6,"months"))){var g="Exclude until time cannot be less than 6 months.";return h=!1,void a.growl.error({message:g})}if(!d[b]||d[b]<=0||d[b]>c.limit){var g="Please enter a value between 0 and "+c.limit+" for "+c.name;return h=!1,void a.growl.error({message:g})}e[b]=d[b],k[b].limit=d[b],k[b].set=!0}}),h&&c.send(e).then(function(){a.growl.notice({message:"Your changes have been updated".i18n()}),g(),o()})["catch"](function(b){a.growl.error({message:b.message})})}},m=function(){return require(["css!selfexclusion/selfexclusion.css"]),new Promise(function(c){require(["text!selfexclusion/selfexclusion.html"],function(d){var f=a(d).i18n();h=b.createBlankWindow(a("<div/>"),{title:"Self-Exclusion Facilities".i18n(),width:900,minHeight:500,height:500,"data-authorized":"true",destroy:function(){h=null}}),f.appendTo(h),e.bind(f[0],l),n(),c()})})},n=function(){return a.growl.notice({message:"Loading self-exclusion settings.".i18n()}),c.send({get_self_exclusion:1}).then(function(b){b.get_self_exclusion&&(a.each(k,function(a){l[a]=b.get_self_exclusion[a],b.get_self_exclusion[a]&&(k[a].limit=b.get_self_exclusion[a],k[a].set=!0)}),g())})["catch"](function(b){a.growl.error({message:b.message})})},o=function(){if(!d.isUndefined(l.session_duration_limit)&&!d.isNull(l.session_duration_limit)&&d.isFinite(d.toNumber(l.session_duration_limit))){i&&clearTimeout(i);var b=60*l.session_duration_limit*1e3;b-=d.now()-j,b>Math.pow(2,32)&&(b=Math.pow(2,32)),i=setTimeout(function(){a.growl.warning({message:"Logging out because of self-exclusion session time out!".i18n()}),c.invalidate()},b)}},p=function(){h&&h.dialog("destroy"),h=null,i&&clearTimeout(i),i=null,j=null,l.max_balance=null,l.max_turnover=null,l.max_losses=null,l.max_7day_turnover=null,l.max_7day_losses=null,l.max_30day_turnover=null,l.max_30day_losses=null,l.max_open_bets=null,l.session_duration_limit=null,l.exclude_until=null,a("#nav-container a.selfexclusion").addClass("disabled")};return c.events.on("login",function(){c.cached.authorize().then(function(b){b.authorize.is_virtual?p():(j=d.now(),n().then(function(){o()}),a("#nav-container a.selfexclusion").removeClass("disabled"))})["catch"](function(){p()})}),c.events.on("logout",p),{init:function(b){b.click(function(){a(this).hasClass("disabled")||c.cached.authorize().then(function(){h?(n(),h.moveToTop()):m().then(function(){h.dialog("open")})})["catch"](function(a){})})}}});