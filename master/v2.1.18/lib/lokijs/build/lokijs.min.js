!function(a,b){"function"==typeof define&&define.amd?define([],b):"object"==typeof exports?module.exports=b():a.loki=b()}(this,function(){return function(){"use strict";function a(a,b,c){return a===b?c?!0:!1:void 0===a?!0:void 0===b?!1:null===a?!0:null===b?!1:b>a}function b(a,b,c){return a===b?c?!0:!1:void 0===a?!1:void 0===b?!0:null===a?!1:null===b?!0:a>b}function c(c,d,e){return c===d?0:e?a(c,d)?1:-1:b(c,d)?1:-1}function d(a){return Array.isArray(a)?function(b){return-1!==a.indexOf(b)}:a&&"string"==typeof a?function(b){return-1!==a.indexOf(b)}:a&&"object"==typeof a?function(b){return a.hasOwnProperty(b)}:void 0}function e(a,b){var c,d=b||"parse-stringify";return"parse-stringify"===d&&(c=JSON.parse(JSON.stringify(a))),c}function f(){try{return"localStorage"in window&&null!==window.localStorage}catch(a){return!1}}function g(){}function h(a,b){this.filename=a||"loki.db",this.collections=[],this.databaseVersion=1.1,this.engineVersion=1.1,this.autosave=!1,this.autosaveInterval=5e3,this.autosaveHandle=null,this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,this.events={init:[],loaded:[],flushChanges:[],close:[],changes:[],warning:[]};var c=function(){return"undefined"==typeof window?"NODEJS":"undefined"!=typeof global&&global.window?"NODEJS":"undefined"!=typeof document?-1===document.URL.indexOf("http://")&&-1===document.URL.indexOf("https://")?"CORDOVA":"BROWSER":"CORDOVA"};this.ENV=b&&b.hasOwnProperty("env")?b.env:c(),"undefined"===this.ENV&&(this.ENV="NODEJS"),this.configureOptions(b,!0),this.on("init",this.clearChanges)}function i(){this.fs=require("fs")}function j(){}function k(a,b,c,d){return this.collection=a,this.searchIsChained=!b&&!c,this.filteredrows=[],this.filterInitialized=!1,"undefined"!=typeof b&&null!==b?this.find(b,d):"undefined"!=typeof c&&null!==c?this.where(c):this}function l(a,b,c){this.collection=a,this.name=b,this.rebuildPending=!1,this.options=c||{},this.options.hasOwnProperty("persistent")||(this.options.persistent=!1),this.options.hasOwnProperty("sortPriority")||(this.options.sortPriority="passive"),this.resultset=new k(a),this.resultdata=[],this.resultsdirty=!1,this.cachedresultset=null,this.filterPipeline=[],this.sortFunction=null,this.sortCriteria=null,this.sortDirty=!1,this.events={rebuild:[]}}function m(a,b){function c(a,b,c){l.changes.push({name:a,operation:b,obj:JSON.parse(JSON.stringify(c))})}function d(){l.changes=[]}function e(a){a&&(a.meta||(a.meta={}),a.meta.created=(new Date).getTime(),a.meta.revision=0)}function f(a){a&&(a.meta.updated=(new Date).getTime(),a.meta.revision+=1)}function g(a){c(l.name,"I",a)}function h(a){c(l.name,"U",a)}function i(a){e(a),g(a)}function j(a){f(a),h(a)}function k(){o=l.disableChangesApi?e:i,p=l.disableChangesApi?f:j}this.name=a,this.data=[],this.idIndex=[],this.binaryIndices={},this.constraints={unique:{},exact:{}},this.uniqueNames=[],this.transforms={},this.objType=a,this.dirty=!0,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null;var l=this;b=b||{},b.hasOwnProperty("unique")&&(Array.isArray(b.unique)||(b.unique=[b.unique]),b.unique.forEach(function(a){l.uniqueNames.push(a),l.constraints.unique[a]=new x(a)})),b.hasOwnProperty("exact")&&b.exact.forEach(function(a){l.constraints.exact[a]=new y(a)}),this.transactional=b.hasOwnProperty("transactional")?b.transactional:!1,this.cloneObjects=b.hasOwnProperty("clone")?b.clone:!1,this.asyncListeners=b.hasOwnProperty("asyncListeners")?b.asyncListeners:!1,this.disableChangesApi=b.hasOwnProperty("disableChangesApi")?b.disableChangesApi:!0,this.maxId=0,this.DynamicViews=[],this.events={insert:[],update:[],"pre-insert":[],"pre-update":[],close:[],flushbuffer:[],error:[],"delete":[],warning:[]},this.changes=[],this.ensureId();var m=[];if(b&&b.indices)if("[object Array]"===Object.prototype.toString.call(b.indices))m=b.indices;else{if("string"!=typeof b.indices)throw new TypeError("Indices needs to be a string or an array of strings");m=[b.indices]}for(var n=0;n<m.length;n++)this.ensureIndex(m[n]);this.getChanges=function(){return l.changes},this.flushChanges=d;var o,p;k(),this.setChangesApi=function(a){l.disableChangesApi=!a,k()},this.on("insert",function(a){o(a)}),this.on("update",function(a){p(a)}),this.on("delete",function(a){l.disableChangesApi||c(l.name,"R",a)}),this.on("warning",console.warn),d()}function n(a){return-1!==a.indexOf(".")}function o(a){return parseFloat(a,10)}function p(a,b){return a+b}function q(a,b){return a-b}function r(a){return a.reduce(p,0)/a.length}function s(a){var b=r(a),c=a.map(function(a){var c=a-b,d=c*c;return d}),d=r(c),e=Math.sqrt(d);return e}function t(a,b,c){if(c===!1)return a[b];for(var d=b.split("."),e=a;d.length>0;)e=e[d.shift()];return e}function u(a,b,c){for(var d,e,f=0,g=a.length;g>f;){if(e=(f+g)/2|0,d=c.apply(null,[b,a[e]]),0===d)return{found:!0,index:e};0>d?g=e:f=e+1}return{found:!1,index:g}}function v(a){return function(b,c){return u(b,c,a)}}function w(){}function x(a){this.field=a,this.keyMap={},this.lokiMap={}}function y(a){this.index={},this.field=a}function z(a){this.field=a}var A={copyProperties:function(a,b){var c;for(c in a)b[c]=a[c]},resolveTransformObject:function(a,b,c){var d,e;if("number"!=typeof c&&(c=0),++c>=10)return a;for(d in a)"string"==typeof a[d]&&0===a[d].indexOf("[%lktxp]")?(e=a[d].substring(8),b.hasOwnProperty(e)&&(a[d]=b[e])):"object"==typeof a[d]&&(a[d]=A.resolveTransformObject(a[d],b,c));return a},resolveTransformParams:function(a,b){var c,d,e=[];if("undefined"==typeof b)return a;for(c=0;c<a.length;c++)d=JSON.parse(JSON.stringify(a[c])),e.push(A.resolveTransformObject(d,b));return e}},B={$eq:function(a,b){return a===b},$gt:function(a,c){return b(a,c)},$gte:function(a,c){return b(a,c,!0)},$lt:function(b,c){return a(b,c)},$lte:function(b,c){return a(b,c,!0)},$ne:function(a,b){return a!==b},$regex:function(a,b){return b.test(a)},$in:function(a,b){return b.indexOf(a)>-1},$containsAny:function(a,b){var c;return Array.isArray(b)||(b=[b]),c=d(a,b)||function(){return!1},b.reduce(function(a,b){return a?a:c(b)},!1)},$contains:function(a,b){var c;return Array.isArray(b)||(b=[b]),c=d(a,b)||function(){return!1},b.reduce(function(a,b){return a?c(b):a},!0)}},C={$eq:B.$eq,$gt:B.$gt,$gte:B.$gte,$lt:B.$lt,$lte:B.$lte,$ne:B.$ne,$regex:B.$regex,$in:B.$in,$contains:B.$contains,$containsAny:B.$containsAny},D=["$eq","$gt","$gte","$lt","$lte"];return g.prototype.events={},g.prototype.asyncListeners=!1,g.prototype.on=function(a,b){var c=this.events[a];return c||(c=this.events[a]=[]),c.push(b),b},g.prototype.emit=function(a,b){var c=this;if(!a||!this.events[a])throw new Error("No event "+a+" defined");this.events[a].forEach(function(a){c.asyncListeners?setTimeout(function(){a(b)},1):a(b)})},g.prototype.removeListener=function(a,b){if(this.events[a]){var c=this.events[a];c.splice(c.indexOf(b),1)}},h.prototype=new g,h.prototype.getIndexedAdapter=function(){var a;return"function"==typeof require&&(a=require("./loki-indexed-adapter.js")),a},h.prototype.configureOptions=function(a,b){var c={NODEJS:"fs",BROWSER:"localStorage",CORDOVA:"localStorage"},d={fs:i,localStorage:j};if(this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,"undefined"!=typeof a){if(this.options=a,this.options.hasOwnProperty("persistenceMethod")&&"function"==typeof d[a.persistenceMethod]&&(this.persistenceMethod=a.persistenceMethod,this.persistenceAdapter=new d[a.persistenceMethod]),this.options.hasOwnProperty("adapter")&&(this.persistenceMethod="adapter",this.persistenceAdapter=a.adapter),a.hasOwnProperty("autoload")&&"undefined"!=typeof b&&b){var e=this;setTimeout(function(){e.loadDatabase(a,a.autoloadCallback)},1)}this.options.hasOwnProperty("autosaveInterval")&&(this.autosaveDisable(),this.autosaveInterval=parseInt(this.options.autosaveInterval,10)),this.options.hasOwnProperty("autosave")&&this.options.autosave&&(this.autosaveDisable(),this.autosave=!0,this.options.hasOwnProperty("autosaveCallback")?this.autosaveEnable(a,a.autosaveCallback):this.autosaveEnable())}null===this.persistenceAdapter&&(this.persistenceMethod=c[this.ENV],this.persistenceMethod&&(this.persistenceAdapter=new d[this.persistenceMethod]))},h.prototype.anonym=function(a,b){var c=new m("anonym",b);return c.insert(a),c},h.prototype.addCollection=function(a,b){var c=new m(a,b);return this.collections.push(c),c},h.prototype.loadCollection=function(a){if(!a.name)throw new Error("Collection must have a name property to be loaded");this.collections.push(a)},h.prototype.getCollection=function(a){var b,c=this.collections.length;for(b=0;c>b;b+=1)if(this.collections[b].name===a)return this.collections[b];return this.emit("warning","collection "+a+" not found"),null},h.prototype.listCollections=function(){for(var a=this.collections.length,b=[];a--;)b.push({name:this.collections[a].name,type:this.collections[a].objType,count:this.collections[a].data.length});return b},h.prototype.removeCollection=function(a){var b,c=this.collections.length;for(b=0;c>b;b+=1)if(this.collections[b].name===a)return void this.collections.splice(b,1)},h.prototype.getName=function(){return this.name},h.prototype.serializeReplacer=function(a,b){switch(a){case"autosaveHandle":case"persistenceAdapter":case"constraints":return null;default:return b}},h.prototype.serialize=function(){return JSON.stringify(this,this.serializeReplacer)},h.prototype.toJson=h.prototype.serialize,h.prototype.loadJSON=function(a,b){0===a.length&&(a=JSON.stringify({}));var c,d,e,f,g=JSON.parse(a),h=0,i=g.collections?g.collections.length:0;for(this.name=g.name,this.databaseVersion=1,g.hasOwnProperty("databaseVersion")&&(this.databaseVersion=g.databaseVersion),this.collections=[],h;i>h;h+=1){if(c=g.collections[h],d=this.addCollection(c.name),e=c.data.length,f=0,b&&b.hasOwnProperty(c.name)){var j=b[c.name].inflate?b[c.name].inflate:A.copyProperties;for(f;e>f;f++){var k=new b[c.name].proto;j(c.data[f],k),d.data[f]=k}}else for(f;e>f;f++)d.data[f]=c.data[f];if(d.transactional=c.transactional,d.asyncListeners=c.asyncListeners,d.disableChangesApi=c.disableChangesApi,d.cloneObjects=c.cloneObjects,d.maxId=0===c.data.length?0:c.maxId,d.idIndex=c.idIndex,"undefined"!=typeof c.binaryIndices&&(d.binaryIndices=c.binaryIndices),"undefined"!=typeof c.transforms&&(d.transforms=c.transforms),d.ensureId(),d.uniqueNames=[],c.hasOwnProperty("uniqueNames"))for(d.uniqueNames=c.uniqueNames,f=0;f<d.uniqueNames.length;f++)d.ensureUniqueIndex(d.uniqueNames[f]);if("undefined"!=typeof c.DynamicViews)for(var l=0;l<c.DynamicViews.length;l++){var m=c.DynamicViews[l],n=d.addDynamicView(m.name,m.options);n.resultdata=m.resultdata,n.resultsdirty=m.resultsdirty,n.filterPipeline=m.filterPipeline,n.sortCriteria=m.sortCriteria,n.sortFunction=null,n.sortDirty=m.sortDirty,n.resultset.filteredrows=m.resultset.filteredrows,n.resultset.searchIsChained=m.resultset.searchIsChained,n.resultset.filterInitialized=m.resultset.filterInitialized,n.rematerialize({removeWhereFilters:!0})}}},h.prototype.close=function(a){this.autosave&&(this.autosaveDisable(),this.autosaveDirty()&&this.saveDatabase()),a&&this.on("close",a),this.emit("close")},h.prototype.generateChangesNotification=function(a){function b(a){return a.name}var c=[],d=a||this.collections.map(b);return this.collections.forEach(function(a){-1!==d.indexOf(b(a))&&(c=c.concat(a.getChanges()))}),c},h.prototype.serializeChanges=function(a){return JSON.stringify(this.generateChangesNotification(a))},h.prototype.clearChanges=function(){this.collections.forEach(function(a){a.flushChanges&&a.flushChanges()})},i.prototype.loadDatabase=function(a,b){this.fs.readFile(a,{encoding:"utf8"},function(a,c){b(a?new Error(a):c)})},i.prototype.saveDatabase=function(a,b,c){this.fs.writeFile(a,b,c)},j.prototype.loadDatabase=function(a,b){b(f()?localStorage.getItem(a):new Error("localStorage is not available"))},j.prototype.saveDatabase=function(a,b,c){f()?(localStorage.setItem(a,b),c(null)):c(new Error("localStorage is not available"))},h.prototype.loadDatabase=function(a,b){var c=b||function(a){if(a)throw a},d=this;null!==this.persistenceAdapter?this.persistenceAdapter.loadDatabase(this.filename,function(b){"string"==typeof b?(d.loadJSON(b,a||{}),c(null),d.emit("loaded","database "+d.filename+" loaded")):c("object"==typeof b?b:"Database not found")}):c(new Error("persistenceAdapter not configured"))},h.prototype.saveDatabase=function(a){var b=a||function(a){if(a)throw a},c=this;null!==this.persistenceAdapter?this.persistenceAdapter.saveDatabase(this.filename,c.serialize(),function(){c.autosaveClearFlags(),b(null)}):b(new Error("persistenceAdapter not configured"))},h.prototype.save=h.prototype.saveDatabase,h.prototype.autosaveDirty=function(){for(var a=0;a<this.collections.length;a++)if(this.collections[a].dirty)return!0;return!1},h.prototype.autosaveClearFlags=function(){for(var a=0;a<this.collections.length;a++)this.collections[a].dirty=!1},h.prototype.autosaveEnable=function(a,b){this.autosave=!0;var c=5e3,d=this;"undefined"!=typeof this.autosaveInterval&&null!==this.autosaveInterval&&(c=this.autosaveInterval),this.autosaveHandle=setInterval(function(){d.autosaveDirty()&&d.saveDatabase(b)},c)},h.prototype.autosaveDisable=function(){"undefined"!=typeof this.autosaveHandle&&null!==this.autosaveHandle&&(clearInterval(this.autosaveHandle),this.autosaveHandle=null)},k.prototype.toJSON=function(){var a=this.copy();return a.collection=null,a},k.prototype.limit=function(a){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data));var b=this.copy();return b.filteredrows=b.filteredrows.slice(0,a),b},k.prototype.offset=function(a){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data));var b=this.copy();return b.filteredrows=b.filteredrows.splice(a,b.filteredrows.length),b},k.prototype.copy=function(){var a=new k(this.collection,null,null);return a.filteredrows=this.filteredrows.slice(),a.filterInitialized=this.filterInitialized,a},k.prototype.branch=k.prototype.copy,k.prototype.transform=function(a,b){var c,d,e=this;for("undefined"!=typeof b&&(a=A.resolveTransformParams(a,b)),c=0;c<a.length;c++)switch(d=a[c],d.type){case"find":e.find(d.value);break;case"where":e.where(d.value);break;case"simplesort":e.simplesort(d.property,d.desc);break;case"compoundsort":e.compoundsort(d.value);break;case"sort":e.sort(d.value);break;case"limit":e=e.limit(d.value);break;case"offset":e=e.offset(d.value);break;case"map":e=e.map(d.value);break;case"eqJoin":e=e.eqJoin(d.joinData,d.leftJoinKey,d.rightJoinKey,d.mapFun);break;case"mapReduce":e=e.mapReduce(d.mapFunction,d.reduceFunction);break;case"update":e.update(d.value);break;case"remove":e.remove()}return e},k.prototype.sort=function(a){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data));var b=function(a,b){return function(c,d){var e=b.collection.data[c],f=b.collection.data[d];return a(e,f)}}(a,this);return this.filteredrows.sort(b),this},k.prototype.simplesort=function(a,b){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data)),"undefined"==typeof b&&(b=!1);var d=function(a,b,d){return function(e,f){var g=d.collection.data[e],h=d.collection.data[f];return c(g[a],h[a],b)}}(a,b,this);return this.filteredrows.sort(d),this},k.prototype.compoundeval=function(a,b,d){var e=a.length;if(0===e)throw new Error("Invalid call to compoundeval, need at least one property");var f=!1,g=a[0];return"string"!=typeof g&&Array.isArray(g)&&(f=g[1],g=g[0]),b[g]===d[g]?1===e?0:this.compoundeval(a.slice(1),b,d,f):c(b[g],d[g],f)},k.prototype.compoundsort=function(a){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data));var b=function(a,b){return function(c,d){var e=b.collection.data[c],f=b.collection.data[d];return b.compoundeval(a,e,f)}}(a,this);return this.filteredrows.sort(b),this},k.prototype.calculateRange=function(c,d,e){var f=this.collection.data,g=this.collection.binaryIndices[d].values,h=0,i=g.length-1,j=null,k=0,l=g.length-1;if(0===f.length)return[0,-1];var m=f[g[h]][d],n=f[g[i]][d];switch(c){case"$eq":if(a(e,m)||b(e,n))return[0,-1];break;case"$gt":if(b(e,n,!0))return[0,-1];break;case"$gte":if(b(e,n))return[0,-1];break;case"$lt":if(a(e,m,!0))return[0,-1];if(a(n,e))return[0,f.length-1];break;case"$lte":if(a(e,m))return[0,-1];if(a(n,e,!0))return[0,f.length-1]}for(;i>h;)j=Math.floor((h+i)/2),a(f[g[j]][d],e)?h=j+1:i=j;for(k=h,h=0,i=g.length-1;i>h;)j=Math.floor((h+i)/2),a(e,f[g[j]][d])?i=j:h=j+1;l=i;var o=f[g[k]][d],p=f[g[l]][d];switch(c){case"$eq":return o!==e?[0,-1]:(p!==e&&l--,[k,l]);case"$gt":return a(p,e,!0)?[0,-1]:[l,f.length-1];case"$gte":return a(o,e)?[0,-1]:[k,f.length-1];case"$lt":return 0===k&&a(o,e)?[0,0]:[0,k-1];case"$lte":return p!==e&&l--,0===l&&a(p,e)?[0,0]:[0,l];default:return[0,f.length-1]}},k.prototype.findOr=function(a){var b=0,c=0,d=null,e=[],f=null;if(this.filterInitialized){for(e=[],c=0;c<a.length;c++)for(f=this.branch(),f.find(a[c]),f.data(),d=f.filteredrows,b=0;b<d.length;b++)-1===e.indexOf(d[b])&&e.push(d[b]);this.filteredrows=e}else for(c=0;c<a.length;c++)for(f=this.collection.chain(),f.find(a[c]),f.data(),d=f.filteredrows,b=0;b<d.length;b++)-1===this.filteredrows.indexOf(d[b])&&this.filteredrows.push(d[b]);return this.filterInitialized=!0,this},k.prototype.findAnd=function(a){for(var b=0;b<a.length;b++)this.find(a[b]);return this},k.prototype.dotSubScan=function(a,b,c,d){var e,f,g,h=null,i=b.split(".");for(e=0;e<i.length;e++)if(g=i[e],h){for(f=0;f<h.length;f++)if(c(h[f][g],d))return!0}else a=a[g],Array.isArray(a)&&(h=a);return c(a,d)},k.prototype.find=function(a,b){if(0===this.collection.data.length)return this.searchIsChained?(this.filteredrows=[],this.filterInitialized=!0,this):[];var c,d,e,f,g,h,i,j,k=a||"getAll",l=!1,m=[],n=null,o=!0;b=b||!1;for(f in k){o=!1;break}if(o&&(k="getAll"),"getAll"===k)return this.searchIsChained?(this.filteredrows=Object.keys(this.collection.data),this):this.collection.data;var p=!1;for(f in k)if(k.hasOwnProperty(f)){if(c=f,"$and"===f)return this.searchIsChained?(this.findAnd(k[f]),b&&this.filteredrows.length>1&&(this.filteredrows=this.filteredrows.slice(0,1)),this):(m=this.collection.chain().findAnd(k[f]).data(),b?0===m.length?[]:m[0]:m);if("$or"===f)return this.searchIsChained?(this.findOr(k[f]),b&&this.filteredrows.length>1&&(this.filteredrows=this.filteredrows.slice(0,1)),this):(m=this.collection.chain().findOr(k[f]).data(),b?0===m.length?[]:m[0]:m);if(-1!=f.indexOf(".")&&(p=!0),null===k[f]||"object"!=typeof k[f])e="$eq",d=k[f];else{if("object"!=typeof k[f])throw"Do not know what you want to do.";for(g in k[f])k[f].hasOwnProperty(g)&&(e=g,d=k[f][g])}break}if("$regex"===e&&(d=new RegExp(d)),null===this.collection.data)throw new TypeError;if((!this.searchIsChained||this.searchIsChained&&!this.filterInitialized)&&-1!==D.indexOf(e)&&this.collection.binaryIndices.hasOwnProperty(c)&&(this.collection.ensureIndex(c),l=!0,n=this.collection.binaryIndices[c]),h=C[e],this.searchIsChained){if(this.filterInitialized){if(l)for(i=n,j=this.filteredrows.length;j--;)h(i[this.filteredrows[j]],d)&&m.push(this.filteredrows[j]);else if(i=this.collection.data,j=this.filteredrows.length,p)for(;j--;)this.dotSubScan(i[this.filteredrows[j]],c,h,d)&&m.push(this.filteredrows[j]);else for(;j--;)h(i[this.filteredrows[j]][c],d)&&m.push(this.filteredrows[j]);return this.filteredrows=m,this}if(l){i=this.collection.data;for(var q=this.calculateRange(e,c,d,this),r=q[0];r<=q[1];r++)m.push(n.values[r]);this.filteredrows=m}else if(i=this.collection.data,j=i.length,p)for(;j--;)this.dotSubScan(i[j],c,h,d)&&m.push(j);else for(;j--;)h(i[j][c],d)&&m.push(j);return this.filteredrows=m,this.filterInitialized=!0,this}if(l){i=this.collection.data;var s=this.calculateRange(e,c,d,this);if(b)return-1!==s[1]?i[n.values[s[0]]]:[];for(j=s[0];j<=s[1];j++)m.push(i[n.values[j]]);this.filteredrows=m}else{if(i=this.collection.data,j=i.length,b){if(p){for(;j--;)if(this.dotSubScan(i[j],c,h,d))return i[j]}else for(;j--;)if(h(i[j][c],d))return i[j];return[]}if(p)for(;j--;)this.dotSubScan(i[j],c,h,d)&&m.push(i[j]);else for(;j--;)h(i[j][c],d)&&m.push(i[j])}return m},k.prototype.where=function(a){var b,c=[];if("function"!=typeof a)throw"Argument is not a stored view or a function";b=a;try{if(this.searchIsChained){if(this.filterInitialized){for(var d=this.filteredrows.length;d--;)b(this.collection.data[this.filteredrows[d]])===!0&&c.push(this.filteredrows[d]);return this.filteredrows=c,this}for(var e=this.collection.data.length;e--;)b(this.collection.data[e])===!0&&c.push(e);return this.filteredrows=c,this.filterInitialized=!0,this}for(var f=this.collection.data.length;f--;)b(this.collection.data[f])===!0&&c.push(this.collection.data[f]);return c}catch(g){throw g}},k.prototype.data=function(){var a=[];if(this.searchIsChained&&!this.filterInitialized){if(0===this.filteredrows.length)return this.collection.data;this.filterInitialized=!0}var b,c=this.collection.data,d=this.filteredrows,e=this.filteredrows.length;for(b=0;e>b;b++)a.push(c[d[b]]);return a},k.prototype.update=function(a){if("function"!=typeof a)throw"Argument is not a function";this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data));for(var b=this.filteredrows.length,c=this.collection.data,d=0;b>d;d++)a(c[this.filteredrows[d]]),this.collection.update(c[this.filteredrows[d]]);return this},k.prototype.remove=function(){this.searchIsChained&&!this.filterInitialized&&0===this.filteredrows.length&&(this.filteredrows=Object.keys(this.collection.data));for(var a=this.filteredrows.length,b=0;a>b;b++)this.collection.remove(this.filteredrows[b]);return this.filteredrows=[],this},k.prototype.mapReduce=function(a,b){try{return b(this.data().map(a))}catch(c){throw c}},k.prototype.eqJoin=function(a,b,c,d){var e,f,g,h=[],i=[],j=[],l="function"==typeof b,n="function"==typeof c,o={};if(h=this.data(),e=h.length,a instanceof k)i=a.data();else{if(!Array.isArray(a))throw new TypeError("joinData needs to be an array or result set");i=a}f=i.length;for(var p=0;f>p;p++)g=n?c(i[p]):i[p][c],o[g]=i[p];d||(d=function(a,b){return{left:a,right:b}});for(var q=0;e>q;q++)g=l?b(h[q]):h[q][b],j.push(d(h[q],o[g]||{}));return this.collection=new m("joinData"),this.collection.insert(j),this.filteredrows=[],this.filterInitialized=!1,this},k.prototype.map=function(a){var b=this.data().map(a);return this.collection=new m("mappedData"),this.collection.insert(b),this.filteredrows=[],this.filterInitialized=!1,this},l.prototype=new g,l.prototype.rematerialize=function(a){var b,c,d;if(a=a||{},this.resultdata=[],this.resultsdirty=!0,this.resultset=new k(this.collection),(this.sortFunction||this.sortCriteria)&&(this.sortDirty=!0),a.hasOwnProperty("removeWhereFilters"))for(b=this.filterPipeline.length,c=b;c--;)"where"===this.filterPipeline[c].type&&(c!==this.filterPipeline.length-1&&(this.filterPipeline[c]=this.filterPipeline[this.filterPipeline.length-1]),this.filterPipeline.length--);var e=this.filterPipeline;for(this.filterPipeline=[],b=e.length,d=0;b>d;d++)this.applyFind(e[d].val);return this.data(),this.emit("rebuild",this),this},l.prototype.branchResultset=function(a,b){var c=this.resultset.copy();return"undefined"==typeof a?c:("string"==typeof a&&this.collection.transforms.hasOwnProperty(a)&&(a=this.collection.transforms[a]),"object"==typeof a&&Array.isArray(a)?c.transform(a,b):c)},l.prototype.toJSON=function(){var a=new l(this.collection,this.name,this.options);return a.resultset=this.resultset,a.resultdata=[],a.resultsdirty=!0,a.filterPipeline=this.filterPipeline,a.sortFunction=this.sortFunction,a.sortCriteria=this.sortCriteria,a.sortDirty=this.sortDirty,a.collection=null,a},l.prototype.applySort=function(a){return this.sortFunction=a,this.sortCriteria=null,this.queueSortPhase(),this},l.prototype.applySimpleSort=function(a,b){return"undefined"==typeof b&&(b=!1),this.sortCriteria=[[a,b]],this.sortFunction=null,this.queueSortPhase(),this},l.prototype.applySortCriteria=function(a){return this.sortCriterial=a,this.sortFunction=null,this.queueSortPhase(),this},l.prototype.startTransaction=function(){return this.cachedresultset=this.resultset.copy(),this},l.prototype.commit=function(){return this.cachedresultset=null,this},l.prototype.rollback=function(){return this.resultset=this.cachedresultset,this.options.persistent&&(this.resultdata=this.resultset.data(),this.emit("rebuild",this)),this},l.prototype.applyFind=function(a){return this.filterPipeline.push({type:"find",val:a}),this.resultset.find(a),(this.sortFunction||this.sortCriteria)&&(this.sortDirty=!0,this.queueSortPhase()),this.options.persistent&&(this.resultsdirty=!0,this.queueSortPhase()),this},l.prototype.applyWhere=function(a){return this.filterPipeline.push({type:"where",val:a}),this.resultset.where(a),(this.sortFunction||this.sortCriteria)&&(this.sortDirty=!0,this.queueSortPhase()),this.options.persistent&&(this.resultsdirty=!0,this.queueSortPhase()),this},l.prototype.data=function(){return(this.sortDirty||this.resultsdirty||!this.resultset.filterInitialized)&&this.performSortPhase(),this.options.persistent?this.resultdata:this.resultset.data()},l.prototype.queueRebuildEvent=function(){var a=this;this.rebuildPending||(this.rebuildPending=!0,setTimeout(function(){a.rebuildPending=!1,a.emit("rebuild",this)},1))},l.prototype.queueSortPhase=function(){var a=this;this.sortDirty||(this.sortDirty=!0,"active"===this.options.sortPriority?setTimeout(function(){a.performSortPhase()},1):this.queueRebuildEvent())},l.prototype.performSortPhase=function(){if(this.sortDirty||this.resultsdirty||!this.resultset.filterInitialized){if(this.sortFunction&&this.resultset.sort(this.sortFunction),this.sortCriteria&&this.resultset.compoundsort(this.sortCriteria),!this.options.persistent)return void(this.sortDirty=!1);this.resultdata=this.resultset.data(),this.resultsdirty=!1,this.sortDirty=!1,this.emit("rebuild",this)}},l.prototype.evaluateDocument=function(a){var b=this.resultset.filteredrows,c=b.indexOf(a),d=b.length,e=new k(this.collection);e.filteredrows=[a],e.filterInitialized=!0;for(var f=0;f<this.filterPipeline.length;f++)switch(this.filterPipeline[f].type){case"find":e.find(this.filterPipeline[f].val);break;case"where":e.where(this.filterPipeline[f].val)}var g=0===e.filteredrows.length?-1:0;return-1!=c||-1!=g?-1===c&&-1!==g?(b.push(a),this.options.persistent&&this.resultdata.push(this.collection.data[a]),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent())):-1!==c&&-1===g?(d-1>c?(b[c]=b[d-1],b.length=d-1,this.options.persistent&&(this.resultdata[c]=this.resultdata[d-1],this.resultdata.length=d-1)):(b.length=d-1,this.options.persistent&&(this.resultdata.length=d-1)),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent())):-1!==c&&-1!==g?(this.options.persistent&&(this.resultdata[c]=this.collection.data[a]),void(this.sortFunction||this.sortCriteria?this.queueSortPhase():this.queueRebuildEvent())):void 0:void 0},l.prototype.removeDocument=function(a){var b,c=this.resultset.filteredrows,d=c.indexOf(a),e=c.length;for(-1!==d&&(e-1>d?(c[d]=c[e-1],c.length=e-1,this.options.persistent&&(this.resultdata[d]=this.resultdata[e-1],this.resultdata.length=e-1)):(c.length=e-1,this.options.persistent&&(this.resultdata.length=e-1)),(this.sortFunction||this.sortCriteria)&&this.queueSortPhase()),e=c.length,b=0;e>b;b++)c[b]>a&&c[b]--},l.prototype.mapReduce=function(a,b){try{return b(this.data().map(a))}catch(c){throw c}},m.prototype=new g,m.prototype.addTransform=function(a,b){if(this.transforms.hasOwnProperty(a))throw new Error("a transform by that name already exists");this.transforms[a]=b},m.prototype.setTransform=function(a,b){this.transforms[a]=b},m.prototype.removeTransform=function(a){delete transforms[a]},m.prototype.byExample=function(a){var b,c,d;d=[];for(b in a)a.hasOwnProperty(b)&&d.push((c={},c[b]=a[b],c));return{$and:d}},m.prototype.findObject=function(a){return this.findOne(this.byExample(a))},m.prototype.findObjects=function(a){return this.find(this.byExample(a))},m.prototype.ensureIndex=function(c,d){if("undefined"==typeof d&&(d=!1),null===c||void 0===c)throw"Attempting to set index without an associated property";if(!this.binaryIndices.hasOwnProperty(c)||d||this.binaryIndices[c].dirty){this.binaryIndices[c]={name:c,dirty:!0,values:[]};var e,f=this.data.length,g=0;for(e=this.binaryIndices[c],g;f>g;g+=1)e.values.push(g);var h=function(c,d){return function(e,f){var g=d.data[e],h=d.data[f];return g[c]===h[c]?0:b(g[c],h[c])?1:a(g[c],h[c])?-1:void 0}}(c,this);e.values.sort(h),e.dirty=!1,this.dirty=!0}},m.prototype.ensureUniqueIndex=function(a){var b=this.constraints.unique[a];b||(-1==this.uniqueNames.indexOf(a)&&this.uniqueNames.push(a),this.constraints.unique[a]=b=new x(a));return this.data.forEach(function(a){b.set(a)}),b},m.prototype.ensureAllIndexes=function(a){for(var b=Object.keys(this.binaryIndices),c=b.length;c--;)this.ensureIndex(b[c],a)},m.prototype.flagBinaryIndexesDirty=function(){for(var a=Object.keys(this.binaryIndices),b=a.length;b--;)this.binaryIndices[a[b]].dirty=!0},m.prototype.count=function(){return this.data.length},m.prototype.ensureId=function(){var a=this.data.length,b=0;for(this.idIndex=[],b;a>b;b+=1)this.idIndex.push(this.data[b].$loki)},m.prototype.ensureIdAsync=function(a){this.async(function(){this.ensureId()},a)},m.prototype.addDynamicView=function(a,b){var c=new l(this,a,b);return this.DynamicViews.push(c),c},m.prototype.removeDynamicView=function(a){for(var b=0;b<this.DynamicViews.length;b++)this.DynamicViews[b].name===a&&this.DynamicViews.splice(b,1)},m.prototype.getDynamicView=function(a){for(var b=0;b<this.DynamicViews.length;b++)if(this.DynamicViews[b].name===a)return this.DynamicViews[b];return null},m.prototype.findAndUpdate=function(a,b){var c,d=this.where(a),e=0;try{for(e;e<d.length;e++)c=b(d[e]),this.update(c)}catch(f){this.rollback()}},m.prototype.insert=function(a){if(!a){var b=new Error("Object cannot be null");throw this.emit("error",b),b}var c,d=this,e=Array.isArray(a)?a:[a],f=[];return e.forEach(function(a){if("object"!=typeof a)throw new TypeError("Document needs to be an object");return c=d.cloneObjects?JSON.parse(JSON.stringify(a)):a,"undefined"==typeof c.meta&&(c.meta={revision:0,created:0}),d.emit("pre-insert",c),d.add(c)?(d.emit("insert",c),void f.push(c)):void 0}),1===f.length?f[0]:f},m.prototype.clear=function(){this.data=[],this.idIndex=[],this.binaryIndices={},this.cachedIndex=null,this.cachedData=null,this.maxId=0,this.DynamicViews=[],this.dirty=!0},m.prototype.update=function(a){if(Object.keys(this.binaryIndices).length>0&&this.flagBinaryIndexesDirty(),Array.isArray(a)){var b=0,c=a.length;for(b;c>b;b+=1)this.update(a[b])}else{if(!a.hasOwnProperty("$loki"))throw"Trying to update unsynced document. Please save the document first by using insert() or addMany()";try{this.startTransaction();var d,e,f=this.get(a.$loki,!0),g=this;if(!f)throw new Error("Trying to update a document not in collection.");this.emit("pre-update",a),d=f[0],Object.keys(this.constraints.unique).forEach(function(a){g.constraints.unique[a].update(d)}),e=f[1],this.data[e]=a;for(var h=0;h<this.DynamicViews.length;h++)this.DynamicViews[h].evaluateDocument(e);return this.idIndex[e]=d.$loki,this.commit(),this.dirty=!0,this.emit("update",a),a}catch(i){throw this.rollback(),this.emit("error",i),i}}},m.prototype.add=function(a){var b=this.DynamicViews.length;if("object"!=typeof a)throw"Object being added needs to be an object";if(Object.keys(this.binaryIndices).length>0&&this.flagBinaryIndexesDirty(),"undefined"!=typeof a.$loki)throw"Document is already in collection, please use update()";try{this.startTransaction(),this.maxId++,isNaN(this.maxId)&&(this.maxId=this.data[this.data.length-1].$loki+1),a.$loki=this.maxId,a.meta.version=0;var c=this;

Object.keys(this.constraints.unique).forEach(function(b){c.constraints.unique[b].set(a)}),this.data.push(a);for(var d=0;b>d;d++)this.DynamicViews[d].evaluateDocument(this.data.length-1);return this.idIndex.push(a.$loki),this.commit(),this.dirty=!0,a}catch(e){this.rollback()}},m.prototype.removeWhere=function(a){var b;b="function"==typeof a?this.data.filter(a):new k(this,a);for(var c=b.length;c--;)this.remove(b[c]);var d;for(d in this.DynamicViews)this.DynamicViews[d].rematerialize()},m.prototype.removeDataOnly=function(){this.removeWhere(function(){return!0})},m.prototype.remove=function(a){if("number"==typeof a&&(a=this.get(a)),"object"!=typeof a)throw new Error("Parameter is not an object");if(Array.isArray(a)){var b=0,c=a.length;for(b;c>b;b+=1)this.remove(a[b])}else{if(!a.hasOwnProperty("$loki"))throw new Error("Object is not a document stored in the collection");Object.keys(this.binaryIndices).length>0&&this.flagBinaryIndexesDirty();try{this.startTransaction();var d=this.get(a.$loki,!0),e=d[1],f=this;Object.keys(this.constraints.unique).forEach(function(b){null!==a[b]&&"undefined"!=typeof a[b]&&f.constraints.unique[b].remove(a[b])});for(var g=0;g<this.DynamicViews.length;g++)this.DynamicViews[g].removeDocument(e);return this.data.splice(e,1),this.idIndex.splice(e,1),this.commit(),this.dirty=!0,this.emit("delete",d[0]),delete a.$loki,delete a.meta,a}catch(h){return this.rollback(),this.emit("error",h),null}}},m.prototype.get=function(a,b){var c=b||!1,d=this.idIndex,e=d.length-1,f=0,g=Math.floor(f+(e-f)/2);if(a="number"==typeof a?a:parseInt(a,10),isNaN(a))throw"Passed id is not an integer";for(;d[f]<d[e];)g=Math.floor((f+e)/2),d[g]<a?f=g+1:e=g;return e===f&&d[f]===a?c?[this.data[f],f]:this.data[f]:null},m.prototype.by=function(a,b){var c;return b?this.constraints.unique[a].get(b):(c=this,function(b){return c.by(a,b)})},m.prototype.findOne=function(a){var b=new k(this,a,null,!0);return Array.isArray(b)&&0===b.length?null:b},m.prototype.chain=function(a,b){var c=new k(this,null,null);return"undefined"==typeof a?c:("string"==typeof a&&this.transforms.hasOwnProperty(a)&&(a=this.transforms[a]),"object"==typeof a&&Array.isArray(a)?c.transform(a,b):null)},m.prototype.find=function(a){return"undefined"==typeof a&&(a="getAll"),new k(this,a,null)},m.prototype.findOneUnindexed=function(a,b){for(var c,d=this.data.length;d--;)if(this.data[d][a]===b)return c=this.data[d];return null},m.prototype.startTransaction=function(){if(this.transactional){this.cachedData=e(this.data,"parse-stringify"),this.cachedIndex=this.idIndex,this.cachedBinaryIndex=this.binaryIndices;for(var a=0;a<this.DynamicViews.length;a++)this.DynamicViews[a].startTransaction()}},m.prototype.commit=function(){if(this.transactional){this.cachedData=null,this.cachedIndex=null,this.cachedBinaryIndices=null;for(var a=0;a<this.DynamicViews.length;a++)this.DynamicViews[a].commit()}},m.prototype.rollback=function(){if(this.transactional){null!==this.cachedData&&null!==this.cachedIndex&&(this.data=this.cachedData,this.idIndex=this.cachedIndex,this.binaryIndices=this.cachedBinaryIndex);for(var a=0;a<this.DynamicViews.length;a++)this.DynamicViews[a].rollback()}},m.prototype.async=function(a,b){setTimeout(function(){if("function"!=typeof a)throw"Argument passed for async execution is not a function";a(),b()},0)},m.prototype.where=function(a){return new k(this,null,a)},m.prototype.mapReduce=function(a,b){try{return b(this.data.map(a))}catch(c){throw c}},m.prototype.eqJoin=function(a,b,c,d){return new k(this).eqJoin(a,b,c,d)},m.prototype.stages={},m.prototype.getStage=function(a){return this.stages[a]||(this.stages[a]={}),this.stages[a]},m.prototype.commitLog=[],m.prototype.stage=function(a,b){var c=JSON.parse(JSON.stringify(b));return this.getStage(a)[b.$loki]=c,c},m.prototype.commitStage=function(a,b){var c,d=this.getStage(a),e=(new Date).getTime();for(c in d)this.update(d[c]),this.commitLog.push({timestamp:e,message:b,data:JSON.parse(JSON.stringify(d[c]))});this.stages[a]={}},m.prototype.no_op=function(){},m.prototype.extract=function(a){var b=0,c=this.data.length,d=n(a),e=[];for(b;c>b;b+=1)e.push(t(this.data[b],a,d));return e},m.prototype.max=function(a){return Math.max.apply(null,this.extract(a))},m.prototype.min=function(a){return Math.min.apply(null,this.extract(a))},m.prototype.maxRecord=function(a){var b,c=0,d=this.data.length,e=n(a),f={index:0,value:void 0};for(c;d>c;c+=1)void 0!==b?b<t(this.data[c],a,e)&&(b=t(this.data[c],a,e),f.index=this.data[c].$loki):(b=t(this.data[c],a,e),f.index=this.data[c].$loki);return f.value=b,f},m.prototype.minRecord=function(a){var b,c=0,d=this.data.length,e=n(a),f={index:0,value:void 0};for(c;d>c;c+=1)void 0!==b?b>t(this.data[c],a,e)&&(b=t(this.data[c],a,e),f.index=this.data[c].$loki):(b=t(this.data[c],a,e),f.index=this.data[c].$loki);return f.value=b,f},m.prototype.extractNumerical=function(a){return this.extract(a).map(o).filter(Number).filter(function(a){return!isNaN(a)})},m.prototype.avg=function(a){return r(this.extractNumerical(a))},m.prototype.stdDev=function(a){return s(this.extractNumerical(a))},m.prototype.mode=function(a){var b={},c=this.extract(a);c.forEach(function(a){b[a]?b[a]+=1:b[a]=1});var d,e,f;for(e in b)d?d<b[e]&&(f=e):(f=e,d=b[e]);return f},m.prototype.median=function(a){var b=this.extractNumerical(a);b.sort(q);var c=Math.floor(b.length/2);return b.length%2?b[c]:(b[c-1]+b[c])/2},w.prototype={keys:[],values:[],sort:function(a,b){return b>a?-1:a>b?1:0},setSort:function(a){this.bs=new v(a)},bs:function(){return new v(this.sort)},set:function(a,b){var c=this.bs(this.keys,a);c.found?this.values[c.index]=b:(this.keys.splice(c.index,0,a),this.values.splice(c.index,0,b))},get:function(a){return this.values[u(this.keys,a,this.sort).index]}},x.prototype.keyMap={},x.prototype.lokiMap={},x.prototype.set=function(a){if(null!==a[this.field]&&"undefined"!=typeof a[this.field]){if(this.keyMap[a[this.field]])throw new Error("Duplicate key for property "+this.field+": "+a[this.field]);this.keyMap[a[this.field]]=a,this.lokiMap[a.$loki]=a[this.field]}},x.prototype.get=function(a){return this.keyMap[a]},x.prototype.byId=function(a){return this.keyMap[this.lokiMap[a]]},x.prototype.update=function(a){if(this.lokiMap[a.$loki]!==a[this.field]){var b=this.lokiMap[a.$loki];this.set(a),this.keyMap[b]=void 0}else this.keyMap[a[this.field]]=a},x.prototype.remove=function(a){var b=this.keyMap[a];if(null===b||"undefined"==typeof b)throw new Error("Key is not in unique index: "+this.field);this.keyMap[a]=void 0,this.lokiMap[b.$loki]=void 0},x.prototype.clear=function(){this.keyMap={},this.lokiMap={}},y.prototype={set:function(a,b){this.index[a]?this.index[a].push(b):this.index[a]=[b]},remove:function(a,b){var c=this.index[a];for(var d in c)c[d]==b&&c.splice(d,1);c.length<1&&(this.index[a]=void 0)},get:function(a){return this.index[a]},clear:function(){this.index={}}},z.prototype={keys:[],values:[],sort:function(a,b){return b>a?-1:a>b?1:0},bs:function(){return new v(this.sort)},setSort:function(a){this.bs=new v(a)},set:function(a,b){var c=u(this.keys,a,this.sort);c.found?this.values[c.index].push(b):(this.keys.splice(c.index,0,a),this.values.splice(c.index,0,[b]))},get:function(a){var b=u(this.keys,a,this.sort);return b.found?this.values[b.index]:[]},getLt:function(a){var b=u(this.keys,a,this.sort),c=b.index;return b.found&&c--,this.getAll(a,0,c)},getGt:function(a){var b=u(this.keys,a,this.sort),c=b.index;return b.found&&c++,this.getAll(a,c,this.keys.length)},getAll:function(a,b,c){for(var d=[],e=b;c>e;e++)d=d.concat(this.values[e]);return d},getPos:function(a){return u(this.keys,a,this.sort)},remove:function(a,b){var c=u(this.keys,a,this.sort).index,d=this.values[c];for(var e in d)d[e]==b&&d.splice(e,1);d.length<1&&(this.keys.splice(c,1),this.values.splice(c,1))},clear:function(){this.keys=[],this.values=[]}},h.Collection=m,h.KeyValueStore=w,h}()});